# 🚀 立即操作指南

## 📌 问题总结

**错误**：`Extraction text must be a string, integer, or float. Found: <class 'dict'>`

**根本原因**：`EXAMPLES` 中的 `attributes` 包含了嵌套字典 `extra: {...}`，违反了 langextract 的类型约束。

**解决方案**：将所有嵌套字段平铺到 `attributes` 顶层。

---

## ✅ 已完成的修改

### 1. 修改 EXAMPLES（最关键）
- ✅ 移除 `"extra": {"country": "USA"}` 嵌套字典
- ✅ 改为 `"country": "USA"` 平铺字段
- ✅ 所有 attributes 只包含简单类型

### 2. 更新数据提取逻辑
- ✅ `_extract_graph_items()` 适配平铺结构
- ✅ 添加类型检查和警告

### 3. 添加详细调试日志
- ✅ 记录提取参数
- ✅ 记录提取结果
- ✅ 记录类型异常

---

## 🔄 立即执行步骤

### 步骤 1：停止 Worker

```bash
pkill -f "celery.*worker"
```

### 步骤 2：验证代码已更新（可选）

```bash
cd /Users/zhangrui/Desktop/konwledge-graph/GP_back_end_py

# 检查 EXAMPLES 是否已更新
grep '"extra":' app/services/langextract_client.py

# 应该只看到注释，或者根本没有匹配
```

### 步骤 3：重启 Worker

```bash
cd /Users/zhangrui/Desktop/konwledge-graph/GP_back_end_py

# 前台运行（推荐，可以直接看日志）
celery -A app.main.celery_app worker --loglevel=info

# 或后台运行
# celery -A app.main.celery_app worker --loglevel=info --logfile=worker.log --detach
```

### 步骤 4：重新提交任务

通过前端界面重新提交知识图谱提取任务。

### 步骤 5：观察日志

---

## 📊 预期结果

### ✅ 成功的日志

```
[INFO] langextract extract params: model_id=gpt-4o-mini, extraction_passes=2
[INFO] langextract extract success: total_extractions=25
[INFO] langextract response task_id=59 url=https://... entities=15 relations=10
```

**关键点**：
- 不再看到 `Extraction text must be a string` 错误
- 看到 `extract success` 日志
- 看到提取的实体和关系数量

### ⚠️ 如果仍有问题

现在会看到更详细的调试日志：

```
[WARNING] Unexpected extraction_text type: type=dict value={...}
[DEBUG] extraction #0: class=entity, text_type=dict, text_value=...
[WARNING] Nested dict found in entity attributes key=extra
```

这些日志会帮助进一步定位问题。

---

## 🔍 验证修复

### 方法 1：查看日志输出

成功提取会显示：
```
[INFO] langextract response task_id=X entities=N relations=M payload={"entities":[...], "relations":[...]}
```

### 方法 2：查看数据库

检查 `site_task` 表中的 `graph_json` 字段是否有数据：

```sql
SELECT id, url, graph_json FROM site_task WHERE id = 59;
```

### 方法 3：通过前端查看

在前端界面查看知识图谱可视化结果。

---

## 🐛 故障排查

### 问题 1：Worker 没有重启成功

**症状**：
```
pkill 后重新运行 celery 命令，但看到 "Already running" 或类似错误
```

**解决**：
```bash
# 强制杀死所有 celery 进程
ps aux | grep celery | grep -v grep | awk '{print $2}' | xargs kill -9

# 等待几秒
sleep 3

# 重新启动
celery -A app.main.celery_app worker --loglevel=info
```

### 问题 2：看不到新的日志

**症状**：
日志输出格式和之前一样，没有看到新增的调试日志。

**原因**：
代码没有重新加载，可能是 Python 缓存或进程没有完全重启。

**解决**：
```bash
# 清理 Python 缓存
find . -type d -name "__pycache__" -exec rm -r {} + 2>/dev/null

# 强制重启
pkill -9 -f celery
sleep 3
celery -A app.main.celery_app worker --loglevel=info
```

### 问题 3：错误仍然发生

**症状**：
```
[ERROR] Extraction text must be a string, integer, or float. Found: <class 'dict'>
```

**检查**：
1. 确认 worker 已重启
2. 确认代码已更新
3. 查看新增的调试日志
4. 检查是否还有其他地方定义了嵌套字典

**进一步调试**：
```bash
# 查找所有可能的嵌套字典定义
grep -r '"extra":.*{' app/

# 查看 langextract_client.py 的内容
cat app/services/langextract_client.py | grep -A 10 "EXAMPLES"
```

### 问题 4：提取速度很慢

**原因**：
- `max_workers: 1` 单线程处理
- `extraction_passes: 2` 两轮提取

**优化**（如果需要）：
```yaml
# config.yaml
langextract:
  max_workers: 3          # 增加并发
  extraction_passes: 1    # 减少轮数（可能降低质量）
```

---

## 📞 需要帮助

如果问题仍然存在，请提供以下信息：

### 1. 日志输出（最重要）

```bash
# 最近 100 行日志
tail -100 worker.log

# 或者如果是前台运行，复制终端输出
```

### 2. 代码验证

```bash
# 检查 EXAMPLES
grep -A 20 "EXAMPLES = " app/services/langextract_client.py

# 检查是否有 extra 嵌套字典
grep '"extra":.*{' app/services/langextract_client.py
```

### 3. 环境信息

```bash
# Python 版本
python --version

# langextract 版本
pip show langextract

# Celery 进程
ps aux | grep celery
```

---

## 📚 详细文档

如果需要了解更多技术细节，请参考：

1. **关键修复-EXAMPLES嵌套字典问题.md** ⭐ 最详细的技术分析
2. **重要更新-提示词修复.md** - 提示词相关修复
3. **最终解决方案.md** - 综合解决方案

---

## 🎯 核心要点

### 问题本质
`EXAMPLES` 中的 `attributes` 包含嵌套字典，违反了 langextract 类型约束。

### 解决方案
将所有字段平铺，只使用简单类型（string, int, float）。

### 关键步骤
1. ✅ 修改 EXAMPLES（已完成）
2. ✅ 更新提取逻辑（已完成）
3. ✅ 添加调试日志（已完成）
4. 🔄 **重启 Worker**（立即执行）
5. 🧪 **验证结果**（观察日志）

---

**🚀 现在就重启 Worker，问题应该解决了！**

祝顺利！🎉

