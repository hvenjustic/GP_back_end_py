# 关系抽取优化说明

## 🎯 优化目标

提升 langextract 的关系抽取效果，特别是**隐含关系**的识别能力。

---

## ✅ 已完成的优化

### 1. 增加关系示例（最关键）

**文件**：`app/services/langextract_client.py`

**改进**：
- 在 EXAMPLES 中增加了 3 个隐含关系的示例：
  1. **科学家的专利** → `科学家 -[PUBLISHES]-> 专利`
  2. **工艺影响产量** → `工艺 -[IMPACTS]-> 产量`
  3. **公司发布产品** → `公司 -[ANNOUNCED_LAUNCH_EVENT]-> 产品`

**为什么重要**：
- langextract 从 EXAMPLES 学习抽取模式
- 增加隐含关系示例可以教会 LLM 进行推理
- 示例越丰富，LLM 的抽取能力越强

### 2. 优化提示词

**文件**：`langextract_prompt.md`

**改进**：

#### a) 强化关系抽取重要性
```markdown
### 关系抽取（重点强调）

**⚠️ 关系抽取是核心任务，必须尽可能多地识别关系。**
```

#### b) 添加推理关系指导
- "A 的 B" → 推断为所属关系
- "A 在 B" → 推断为工作关系
- "A 使用 B" → 推断为关联关系

#### c) 增加关系抽取策略
- 显式关系：直接表述的关系
- 隐含关系：需要推断的关系
- 上下文关系：从多句话综合推断

### 3. 调整配置参数

**文件**：`config.yaml`

**改进**：
- `extraction_passes: 1` → `3`（增加提取轮数，提升召回率）
- `max_char_buffer: 200` → `1500`（增加缓冲区，处理更长文本）

**效果**：
- 多轮提取可以发现第一轮遗漏的关系
- 更大的缓冲区可以处理更多上下文信息

---

## 📊 预期效果

### 优化前
- 主要识别显式关系
- 遗漏大量隐含关系
- 关系数量：实体数量 ≈ 1:3 或更低

### 优化后
- 识别显式关系 + 隐含关系
- 通过推理发现更多关系
- 关系数量：实体数量 ≈ 1:1.5 或更高

---

## 🚀 如何验证效果

### 1. 重启 Worker

```bash
cd /Users/zhangrui/Desktop/konwledge-graph/GP_back_end_py
pkill -9 -f "celery.*worker"
sleep 3
find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null
celery -A app.services.crawl_tasks worker --loglevel=info --concurrency=1
```

### 2. 提交测试任务

选择一个包含丰富关系信息的页面（如：
- 公司介绍页面（包含合作伙伴、产品、团队）
- 研究成果页面（包含作者、机构、专利）
- 新闻公告页面（包含事件、人物、产品）

### 3. 检查抽取结果

```bash
# 查看日志中的统计
tail -100 worker.log | grep "langextract response"
# 应该看到：entities=N relations=M
```

**成功标志**：
- `relations` 数量显著增加
- 关系/实体 比例从 < 0.5 提升到 > 0.8
- 日志中看到推断出的关系

---

## 🔍 进一步优化建议

### 如果效果仍不理想

#### 1. 升级模型（最有效）

```yaml
# config.yaml
langextract:
  model_id: "gpt-4o"  # 从 gpt-4o-mini 升级到 gpt-4o
```

**效果**：
- gpt-4o 的推理能力更强
- 更擅长识别隐含关系
- 成本增加约 5-10 倍

#### 2. 增加更多关系示例

在 `langextract_client.py` 的 EXAMPLES 中添加更多场景：
- 融资关系：`公司 -[FUNDING_ROUND]-> 投资`
- 并购关系：`公司 -[M&A_EVENT]-> 被收购公司`
- 描述关系：`专利 -[DESCRIBES]-> 技术`

#### 3. 调整提取轮数

```yaml
# config.yaml
langextract:
  extraction_passes: 5  # 进一步增加（会增加时间和成本）
```

#### 4. 添加后处理逻辑

在 `graph_service.py` 中添加关系推断逻辑：
```python
def infer_relations(entities, relations):
    """根据已有实体和关系，推断缺失的关系"""
    # 例如：如果有 "科学家 A" 和 "专利 B"，且它们在同一文本中
    # 推断 A -[PUBLISHES]-> B
    pass
```

---

## 📈 监控指标

### 关键指标

1. **关系抽取率**
   - 计算：`关系数量 / 实体数量`
   - 目标：> 0.8

2. **关系类型分布**
   - 统计各类型关系的数量
   - 检查是否有遗漏的关系类型

3. **提取时间**
   - `extraction_passes` 增加会延长时间
   - 权衡效果和效率

### 查看统计

```python
# 在数据库中查询
SELECT 
    COUNT(DISTINCT entity_name) as entity_count,
    COUNT(*) as relation_count,
    CAST(COUNT(*) AS FLOAT) / COUNT(DISTINCT entity_name) as ratio
FROM knowledge_graph;
```

---

## 🎓 经验总结

### 关键要点

1. **EXAMPLES 是最重要的**
   - 增加关系示例比修改提示词更有效
   - 特别要添加隐含关系的示例

2. **提示词要明确**
   - 明确告诉 LLM 需要推断关系
   - 给出具体的推理规则和示例

3. **配置参数很关键**
   - `extraction_passes` 影响召回率
   - `max_char_buffer` 影响上下文理解

4. **模型能力是基础**
   - gpt-4o-mini 适合成本敏感场景
   - gpt-4o 适合效果优先场景

### 最佳实践

1. **迭代优化**
   - 先测试小样本
   - 根据结果调整 EXAMPLES 和提示词
   - 逐步扩大测试范围

2. **分析失败案例**
   - 找出遗漏的关系类型
   - 添加对应的示例
   - 优化提示词描述

3. **平衡效果和成本**
   - 多轮提取增加成本
   - 更强的模型增加成本
   - 根据实际需求选择配置

---

## 📞 问题排查

### 关系数量仍然很少

**可能原因**：
1. Worker 没有重启，仍使用旧代码
2. 文本质量差，缺少关系信息
3. 模型能力不足

**解决方法**：
```bash
# 1. 确认 Worker 已重启
ps aux | grep celery | grep -v grep

# 2. 检查 EXAMPLES 是否更新
grep "隐含关系示例" app/services/langextract_client.py

# 3. 查看提取日志
tail -100 worker.log
```

### 关系类型不准确

**可能原因**：
1. 关系类型定义不清晰
2. EXAMPLES 中的关系类型示例不够

**解决方法**：
- 在提示词中详细说明每种关系类型
- 为每种关系类型添加 1-2 个示例

### 提取速度太慢

**可能原因**：
- `extraction_passes` 设置过高
- `max_char_buffer` 过大

**解决方法**：
```yaml
# 降低提取轮数
extraction_passes: 2  # 从 3 降到 2

# 适当降低缓冲区
max_char_buffer: 1000  # 从 1500 降到 1000
```

---

## ✅ 检查清单

优化后需要检查：

- [ ] Worker 已重启
- [ ] EXAMPLES 包含隐含关系示例
- [ ] 提示词强调关系抽取
- [ ] `extraction_passes` 已增加到 3
- [ ] `max_char_buffer` 已增加到 1500
- [ ] 提交测试任务
- [ ] 关系数量明显增加
- [ ] 关系类型更丰富

---

**🎉 完成优化后，关系抽取效果应该有明显提升！**

