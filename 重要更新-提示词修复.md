# 🔥 重要更新：LangExtract 提示词根本性修复

## ⚠️ 问题根源（真正的原因）

经过进一步分析和日志追踪，发现了真正的问题：

### 错误发生在哪里？

```
[2026-01-21 19:19:38,887: ERROR/ForkPoolWorker-1] Extraction text must be a string, integer, or float. Found: <class 'dict'>
```

这个错误是在 **langextract 库内部**抛出的，而不是在我们的代码中。

### 执行流程

```
LLM 返回响应
    ↓
langextract 解析响应并创建 Extraction 对象
    ↓ ❌ 在这里抛出异常！（发现 extraction_text 是字典）
    ↓
我们的代码接收 Extraction 对象 ← 根本没有执行到这里
    ↓
_normalize_extraction_text() 处理 ← 也没有执行到这里
```

**结论**：之前的防御性代码 `_normalize_extraction_text()` 虽然写得很好，但**根本没有机会执行**，因为 langextract 在更早的阶段就抛出了异常。

---

## 🎯 真正的问题：提示词与 langextract 工作方式冲突

### LangExtract 的工作原理

langextract 库的设计理念是：

1. **用户提供 `examples`**（示例数据）
2. **langextract 自动从 examples 推断 JSON schema**
3. **用户只需提供 `prompt_description`**（业务逻辑描述）
4. **langextract 自动构建完整的 prompt**（包括 schema 说明）

```python
lx.extract(
    text_or_documents=text,
    prompt_description="描述要提取什么内容",  # ← 只描述业务逻辑
    examples=EXAMPLES,                        # ← langextract 根据这个生成 schema
    ...
)
```

### 我们犯的错误

**在提示词中详细描述了 JSON 结构**，包括：
- 字段名称和类型
- JSON 对象结构
- 示例 JSON

这导致：
- **两套 schema 定义**：langextract 自动生成的 + 我们手写的
- **LLM 被搞混了**：不知道该按哪个 schema 输出
- **输出格式错误**：LLM 试图"创新"，结果违反了 langextract 的约束

---

## ✅ 正确的解决方案

### 修改策略

**提示词应该只描述业务逻辑，不描述 JSON 结构。**

#### ❌ 错误的提示词（旧版本）

```markdown
## 输出 JSON 模式（必须包含 `extractions`）

你必须返回一个包含 `extractions` 字段的 JSON 对象...

```json
{
  "extractions": [
    {
      "extraction_class": "entity",
      "extraction_text": "实体在原文中的文本片段",
      "attributes": {
        "name": "实体标准名称",
        ...
      }
    }
  ]
}
```
```

**问题**：详细描述了 JSON 结构，与 langextract 自动生成的 schema 冲突。

#### ✅ 正确的提示词（新版本）

```markdown
# 生物技术商业知识图谱信息抽取指南

你是一个专门用于生物技术商业领域的信息抽取专家。

## 任务
从给定的网页文本中，抽取用于构建知识图谱的**实体**和**关系**。

## 实体类型
- Company（公司）
- University（大学）
- Scientist（科学家）
...

## 关系类型
- SUPPLIES：供应关系
- PARTNERS_WITH：合作关系
...

## 抽取要求
1. 准确识别实体类型
2. 只抽取文本明确支持的关系
...

**记住**：langextract 会自动处理输出的 JSON 结构，你只需要专注于识别和抽取正确的实体和关系。
```

**优势**：
- ✅ 只描述业务逻辑（要提取什么）
- ✅ 不涉及 JSON 结构
- ✅ 让 langextract 自动处理 schema
- ✅ LLM 不会被两套说明搞混

---

## 📊 对比总结

| 方面 | 旧方法（错误） | 新方法（正确） |
|------|---------------|---------------|
| **提示词内容** | 业务逻辑 + JSON 结构 | 只有业务逻辑 |
| **Schema 定义** | 手写 + langextract 自动生成（冲突） | 只有 langextract 自动生成 |
| **LLM 理解** | 困惑，不知道按哪个 | 清晰，只有一个标准 |
| **输出格式** | 可能错误 | 符合 langextract 期望 |
| **维护性** | 需要同步维护两处 | 只需维护业务逻辑 |

---

## 🔧 已完成的修改

### 1. 创建新版提示词

**文件**：`langextract_prompt_v2.md` → `langextract_prompt.md`

**改动**：
- ✅ 移除所有 JSON 结构说明
- ✅ 只保留业务逻辑描述
- ✅ 详细说明实体类型和关系类型
- ✅ 明确抽取要求和质量标准
- ✅ 添加抽取策略和注意事项

### 2. 备份旧版提示词

**文件**：`langextract_prompt_old.md.bak`

如果需要回滚，可以恢复旧版本。

### 3. 保留防御性代码

虽然当前问题出在提示词，但 `_normalize_extraction_text()` 函数仍然保留：
- 作为最后一道防线
- 处理其他可能的异常情况
- 提供日志监控能力

---

## 🚀 立即操作

### 1️⃣ 重启 Worker

修改了提示词文件后，**必须重启 worker** 才能生效：

```bash
# 停止 worker
pkill -f "celery.*worker"

# 重启 worker
cd /Users/zhangrui/Desktop/konwledge-graph/GP_back_end_py
celery -A app.main.celery_app worker --loglevel=info
```

### 2️⃣ 重新提交任务

通过前端或 API 重新提交知识图谱提取任务。

### 3️⃣ 观察日志

**✅ 成功的标志**：
- 不再看到 `Extraction text must be a string` 错误
- 看到提取成功：`langextract response task_id=X entities=N relations=M`
- LLM 返回的格式符合 langextract 期望

---

## 📈 预期效果

### 修复前
```
[ERROR] Extraction text must be a string, integer, or float. Found: <class 'dict'>
[WARNING] langextract failed task_id=59 url=https://...
```

### 修复后
```
[INFO] langextract response task_id=59 url=https://... entities=15 relations=8
[INFO] HTTP Request: POST https://yinli.one/v1/chat/completions "HTTP/1.1 200 OK"
```

---

## 🎓 经验教训

### 关键认识

1. **理解库的工作原理**
   - langextract 有自己的 schema 生成机制
   - 不要与库的设计理念对抗

2. **提示词的职责**
   - 只描述"要做什么"（业务逻辑）
   - 不要描述"怎么做"（JSON 结构）
   - 让专业的库处理专业的事

3. **调试的重要性**
   - 错误信息要仔细分析（错误发生在哪里）
   - 追踪执行流程（代码有没有执行到）
   - 理解根本原因（为什么会这样）

### 类比理解

这就像：
- ❌ **错误做法**：同时给翻译员两本不同的语法书，让他翻译
- ✅ **正确做法**：给翻译员一本标准语法书，告诉他要翻译什么内容

---

## 📚 相关文件

### 修改的文件
- ✅ `langextract_prompt.md` - 全新的提示词（只含业务逻辑）
- 📦 `langextract_prompt_old.md.bak` - 旧版本备份

### 保留的文件
- ✅ `app/services/graph_service.py` - 防御性代码仍然保留
- ✅ `app/services/langextract_client.py` - 配置优化仍然有效
- ✅ `test_extraction_text_fix.py` - 测试脚本仍然可用

### 文档文件
- 📄 `LANGEXTRACT_FIX.md` - 之前的修复文档（部分内容已过时）
- 📄 `重要更新-提示词修复.md` - 本文档（最新的根本性修复）

---

## ❓ 常见问题

### Q1: 为什么之前的修复没有效果？

**A**: 因为错误发生在 langextract 库内部，我们的防御性代码根本没有机会执行。

### Q2: 防御性代码还有用吗？

**A**: 有用，作为最后一道防线。但现在从源头解决了问题，防御性代码可能不会被触发。

### Q3: 如果还是不行怎么办？

**A**: 
1. 确认已重启 worker
2. 检查日志中的新错误信息
3. 验证提示词文件已更新（`cat langextract_prompt.md | head -20`）
4. 考虑升级到更强的模型（gpt-4o）

### Q4: 可以自定义实体类型吗？

**A**: 可以！在新版提示词中，只需修改"实体类型"和"关系类型"部分即可。langextract 会根据 examples 自动适应。

---

## 🎉 总结

### 问题本质

**不是代码问题，不是数据问题，而是提示词与 langextract 工作方式不匹配。**

### 解决方案

**让提示词回归本职：只描述业务逻辑，让 langextract 处理 JSON 结构。**

### 关键原则

```
清晰的职责分工 > 详细的格式说明
简洁的业务描述 > 复杂的 JSON schema
信任库的设计 > 自己重复造轮子
```

---

**🚀 现在重启 worker，问题应该彻底解决了！**

如果还有问题，请提供最新的日志信息。

